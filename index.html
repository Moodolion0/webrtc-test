<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WebRTC Firebase Test</title>
</head>
<body>
  <h2>WebRTC Messaging</h2>

  <button id="createOffer">ğŸ“¤ CrÃ©er lâ€™appel</button>
  <button id="answerCall">ğŸ“¥ RÃ©pondre Ã  lâ€™appel</button>

  <br><br>

  <textarea id="messages" cols="40" rows="10" readonly></textarea><br>
  <input id="messageBox" placeholder="Message..." />
  <button id="sendBtn" disabled>Envoyer</button>

  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>

  <script>
    // ğŸ”¹ Mets ici ta config copiÃ©e depuis Firebase
    const firebaseConfig = {
  apiKey: "AIzaSyDJZUQSY8D7PgVSrnrCjeJRy98GDiTac84",
  authDomain: "webrtc-test-7bd51.firebaseapp.com",
  projectId: "webrtc-test-7bd51",
  storageBucket: "webrtc-test-7bd51.firebasestorage.app",
  messagingSenderId: "732591129920",
  appId: "1:732591129920:web:d54162eb134b12349526a5"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const pc = new RTCPeerConnection();
    let dataChannel;
    let callDoc = db.collection("calls").doc("demo");
    let offerCandidates = callDoc.collection("offerCandidates");
    let answerCandidates = callDoc.collection("answerCandidates");

    pc.onicecandidate = e => {
      if (e.candidate) {
        const target = dataChannel ? answerCandidates : offerCandidates;
        target.add(e.candidate.toJSON());
      }
    };

    pc.ondatachannel = e => {
      dataChannel = e.channel;
      setupChannel();
    };

    function setupChannel() {
      dataChannel.onopen = () => {
        document.getElementById("sendBtn").disabled = false;
        log("ğŸ“¡ Canal ouvert !");
      };
      dataChannel.onmessage = e => log("â¬…ï¸ " + e.data);
    }

    function log(msg) {
      document.getElementById("messages").value += msg + "\n";
    }

    document.getElementById("createOffer").onclick = async () => {
      dataChannel = pc.createDataChannel("chat");
      setupChannel();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const roomWithOffer = {
        offer: { type: offer.type, sdp: offer.sdp }
      };
      await callDoc.set(roomWithOffer);

      callDoc.onSnapshot(async snapshot => {
        const data = snapshot.data();
        if (!pc.currentRemoteDescription && data?.answer) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
      });

      answerCandidates.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          }
        });
      });

      log("ğŸ“¤ Offre envoyÃ©e !");
    };

    document.getElementById("answerCall").onclick = async () => {
      const callData = (await callDoc.get()).data();
      const offer = callData.offer;
      await pc.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      const roomWithAnswer = {
        answer: { type: answer.type, sdp: answer.sdp }
      };
      await callDoc.update(roomWithAnswer);

      offerCandidates.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === "added") {
            pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
          }
        });
      });

      log("ğŸ“¥ RÃ©ponse envoyÃ©e !");
    };

    document.getElementById("sendBtn").onclick = () => {
      const msg = document.getElementById("messageBox").value;
      dataChannel.send(msg);
      log("â¡ï¸ " + msg);
    };
  </script>
</body>
</html>
